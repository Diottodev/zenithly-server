name: Deploy to EC2

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging
      restart_only:
        description: "Only restart PM2 without pulling code"
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          debug: true
          timeout: 60
          command_timeout: 60
          script: |
            echo "ğŸš€ Starting deployment to ${{ github.event.inputs.environment }}..."

            # Set application path
            APP_PATH="zenithly-server"
            if [ ! -d "$APP_PATH" ]; then
              APP_PATH="/var/www/zenithly-server"
            fi

            if [ ! -d "$APP_PATH/.git" ]; then
              git clone git@github.com:Diottodev/zenithly-server.git $APP_PATH
            fi

            cd $APP_PATH

            if [ "${{ github.event.inputs.restart_only }}" == "true" ]; then
              echo "ğŸ”„ Restarting PM2 application only..."
              pm2 restart zenithly-server
            else
              echo "ğŸ“¦ Pulling latest changes..."
              git pull origin master
              
              echo "ğŸ“¥ Installing dependencies..."
              yarn install --frozen-lockfile
              
              echo "ğŸ—„ï¸ Running database migrations..."
              yarn db:migrate
              
              echo "ğŸ”„ Restarting PM2 application..."
              pm2 restart zenithly-server || pm2 start ecosystem.config.js
            fi

            echo "âœ… Deployment completed!"
            echo "ğŸ“Š PM2 Status:"
            pm2 status

            echo "ğŸ“ PM2 Logs (last 50 lines):"
            pm2 logs zenithly-server --lines 50
